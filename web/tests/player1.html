<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Homepage</title>
    <style>
      li {
        list-style: none;
        margin-bottom: 0.25rem;
      }
    </style>
  </head>
  <body>
    <h1>Homepage</h1>
    <code>
      <pre><ul id="debug"></ul></pre>
    </code>

    <script type="module">
      import { log, send, ws, sleep } from '../src/controler/debug.js';

      const ships = [
        {
          position: {
            x: 'b',
            y: 2,
            orientation: 'H',
          },
          type: 'Carrier',
        },
        {
          position: {
            x: 'a',
            y: 1,
            orientation: 'V',
          },
          type: 'Battleship',
        },
        {
          position: {
            x: 'c',
            y: 3,
            orientation: 'H',
          },
          type: 'Cruiser',
        },
        {
          position: {
            x: 'd',
            y: 5,
            orientation: 'H',
          },
          type: 'Submarine',
        },
        {
          position: {
            x: 'd',
            y: 6,
            orientation: 'H',
          },
          type: 'Patrol Boat',
        },
      ];

      let step = 0;

      ws.onopen = () => {
        log(`connected to ${ws.url}`);
        send({ action: 'create' });
      };

      ws.onmessage = async event => {
        const { data } = event;
        const message = JSON.parse(data);
        log('received message: ', message);

        switch (step) {
          case 0:
            log('test: modify parameters');
            send({
              action: 'parameters',
              payload: {
                width: 12,
                height: 12,
                ships: [
                  { name: 'Carrier', length: 5, count: 1 },
                  { name: 'Battleship', length: 4, count: 1 },
                  { name: 'Cruiser', length: 3, count: 1 },
                  { name: 'Submarine', length: 3, count: 1 },
                  { name: 'Patrol Boat', length: 2, count: 1 },
                ]
              }
            });
            break;
          case 1:
            // ack
            log('test: send wrong ready message (missing ships)');
            send({
              action: 'ready',
              payload: ships.slice(1),
            });
            break;
          case 2:
            log('test: send wrong ready message (out of bounds position)');
            send({
              action: 'ready',
              payload: [
                {
                  ...ships[0],
                  position: {
                    x: 'b',
                    y: 11,
                    orientation: 'V',
                  },
                },
                ...ships.slice(1),
              ],
            });
            break;
          case 3:
            log('test: send wrong ready message (ship overlaps)');
            send({
              action: 'ready',
              payload: [
                {
                  ...ships[0],
                  position: {
                    x: 'a',
                    b: 4,
                    orientation: 'H',
                  },
                },
                ...ships.slice(1),
              ],
            });
            break;
          case 4:
            log('test: send correct ready message');
            send({
              action: 'ready',
              payload: ships,
            });
            break;
          case 5:
            // ack
            break;
          case 6:
            // start
            // Wait while other player tries to shoot
            await sleep(300);

            log('test: send fire message with no ship');
            send({
              action: 'fire',
              payload: {
                x: 'j',
                y: 10,
              },
            });
            break;
          case 7:
            // ack
            break;
          case 8:
            // enemy fire
            log('test: whatever');
            send({
              action: 'fire',
              payload: {
                x: 'c',
                y: 5,
              },
            });
            break;
          case 9:
            // ack
            log('test: quit');
            send({
              action: 'quit',
            });
            break;
        }

        step++;
      };

      window.addEventListener('close', () => {
        ws.close(1000, 'quitting');
      });
    </script>
  </body>
</html>

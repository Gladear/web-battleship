<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Homepage</title>
    <style>
      li {
        list-style: none;
        margin-bottom: 0.25rem;
      }
    </style>
  </head>
  <body>
    <h1>Homepage</h1>
    <form id="join">
      <input type="text" name="hash" />
      <button type="submit">Se connecter</button>
    </form>
    <code>
      <pre><ul id="debug"></ul></pre>
    </code>

    <script type="module">
      import { log, send, ws } from './debug.js';

      const { join } = document.forms;

      join.onsubmit = event => {
        event.preventDefault();
        send({ action: 'join', payload: join.hash.value });
      };

      const ships = [
        {
          position: {
            x: 2,
            y: 2,
            orientation: 'H',
          },
          type: 'Carrier',
        },
        {
          position: {
            x: 1,
            y: 1,
            orientation: 'V',
          },
          type: 'Battleship',
        },
        {
          position: {
            x: 3,
            y: 3,
            orientation: 'H',
          },
          type: 'Cruiser',
        },
        {
          position: {
            x: 4,
            y: 5,
            orientation: 'H',
          },
          type: 'Submarine',
        },
        {
          position: {
            x: 4,
            y: 6,
            orientation: 'H',
          },
          type: 'Patrol Boat',
        },
      ];

      let step = 0;

      ws.onopen = () => {
        log(`connected to ${ws.url}`);
      };

      ws.onmessage = async event => {
        const { data } = event;
        const message = JSON.parse(data);
        log('received message: ', message);

        switch (step) {
          case 0:
            log('test: send ready message');
            send({
              action: 'ready',
              payload: ships,
            });
            break;
          case 1:
            // ack
            break;
          case 2:
            // start
            log('test: try to fire while not turn');
            send({
              action: 'fire',
              payload: {
                x: 1,
                y: 1,
              },
            });
            break;
          case 3:
            // error message
            break;
          case 4:
            // fire
            log('test: respond to fire');
            send({
              action: 'fire',
              payload: {
                x: 4,
                y: 6,
              },
            });
          case 5:
            // ack
            break;
          case 6:
            // enemy fire
            log('test: break boat');
            send({
              action: 'fire',
              payload: {
                x: 5,
                y: 6,
              },
            });
            break;
        }

        step++;
      };

      window.addEventListener('close', () => ws.close(1000, 'quitting'));
    </script>
  </body>
</html>
